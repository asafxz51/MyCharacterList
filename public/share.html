<!DOCTYPE html>
<html lang="en">

<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <meta name="referrer" content="no-referrer">
 <title>Shared List</title>
 <link rel="stylesheet" href="style.css">
 <style>
  /* Standalone Page Styles */
  body {
   overflow-y: auto;
   padding: 40px 20px;
   height: auto;
   display: block;
   /* Overrides the flex display from style.css body */
  }

  .share-wrapper {
   max-width: 1200px;
   margin: 0 auto;
  }

  .share-header {
   text-align: center;
   margin-bottom: 40px;
   background: var(--card-bg);
   padding: 30px;
   border-radius: 10px;
   box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
  }

  .controls {
   display: flex;
   justify-content: center;
   margin-bottom: 30px;
  }

  #filterSelect {
   width: 250px;
   padding: 10px;
  }

  /* Ensure grid works without the main app container */
  .grid {
   display: grid;
   grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
   gap: 25px;
   padding-bottom: 50px;
  }
 </style>
</head>

<body class="dark-theme">

 <div class="share-wrapper">

  <div class="share-header">
   <h1 id="listTitle" style="font-size: 2.5rem; margin-bottom: 10px;">Loading...</h1>
   <p id="listAuthor" style="color:var(--text-muted); font-size: 1.1rem;"></p>
  </div>

  <!-- FILTER DROPDOWN -->
  <div class="controls">
   <select id="filterSelect">
    <option value="all">Show All</option>
    <option value="Anime">Anime</option>
    <option value="Game">Game</option>
    <option value="Visual Novel">VN</option>
    <option value="TV Show">TV Shows</option>
    <option value="Movie">Movies</option>
    <option value="Manga">Manga</option>
    <option value="Book">Books</option>
    <option value="Actor">Actors</option>
    <option value="Other">Other</option>
   </select>
  </div>

  <div id="grid" class="grid"></div>
 </div>

 <script>
  const params = new URLSearchParams(window.location.search);
  const id = params.get('id');
  let allItems = [];

  // 1. Fetch Data
  fetch(`/api/share/${id}`)
   .then(res => res.json())
   .then(data => {
    if (data.error) {
     document.body.innerHTML = "<h1 style='text-align:center; margin-top:50px;'>List not found</h1>";
     return;
    }

    document.title = data.name;
    document.getElementById('listTitle').textContent = data.name;
    document.getElementById('listAuthor').textContent = `Created by: ${data.author}`;

    allItems = data.items;
    renderList();
   })
   .catch(err => console.error(err));

  // 2. Filter Event
  document.getElementById('filterSelect').addEventListener('change', renderList);

  // 3. Render Function
  function renderList() {
   const grid = document.getElementById('grid');
   grid.innerHTML = '';

   const filterType = document.getElementById('filterSelect').value;

   // Filter
   let displayItems = allItems;
   if (filterType !== 'all') {
    displayItems = allItems.filter(item => item.sourceType === filterType);
   }

   // Sort by Rating
   displayItems.sort((a, b) => b.rating - a.rating);

   if (displayItems.length === 0) {
    grid.innerHTML = '<p style="grid-column: 1/-1; text-align:center; color:#888; font-size:1.2rem;">No characters found for this category.</p>';
    return;
   }

   // Draw Cards
   displayItems.forEach(item => {
    const div = document.createElement('div');
    div.className = 'char-card';
    // Note: We use the exact same HTML structure as app.js
    div.innerHTML = `
                    <div class="char-rating">${item.rating}</div>
                    <img src="${item.image}" class="char-img">
                    <div class="char-info">
                        <div class="char-name">${item.characterName}</div>
                        
                        <div class="source-row">
                            <span class="source-title" title="${item.sourceTitle}">${item.sourceTitle}</span>
                            <span class="red-type">${item.sourceType}</span>
                        </div>
                    </div>
                `;
    grid.appendChild(div);
   });
  }
 </script>
</body>

</html>